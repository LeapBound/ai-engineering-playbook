# OpenCode 集成研究需求（基于 PoC 测试结果）

## 背景

我们希望将 OpenCode 集成到 nanobot 中，实现"规划 → 审批 → 执行"的自动化工作流。初步 PoC 测试发现了一些与预期不符的情况，需要进一步研究。

## PoC 测试发现

### ✅ 可用功能
- `opencode run` 命令可以正常工作
- 能够生成代码和解释

### ❌ 问题发现
1. **输出格式问题**：`opencode run` 输出的是普通文本（代码+解释），不是结构化的 JSON 格式
2. **Session 功能不可用**：`opencode session create` 命令失败，无法创建会话

## 核心研究问题

### 1. 如何获取结构化的执行计划？

**问题：**
- 研究报告提到 `opencode run` 可以输出 JSON 格式的计划
- 实际测试中只得到文本输出
- 是否有参数可以控制输出格式？

**需要确认：**
- `opencode run` 是否支持 `--output-format json` 或类似参数？
- 如果不支持，是否有其他方式获取结构化的执行计划？
- OpenCode 的"规划"和"执行"是否是分离的，还是一次性完成？

### 2. Session 功能如何正确使用？

**问题：**
- `opencode session create` 命令失败
- 错误信息为空，无法判断原因

**需要确认：**
- Session 功能是否需要先启动 `opencode serve`？
- Session 功能的完整使用流程是什么？
- 是否有文档或示例说明如何使用 session？
- Session 功能在哪个版本中可用？我们使用的是 v1.1.33

### 3. 如何实现"规划 → 审批 → 执行"工作流？

**核心需求：**
我们希望实现以下工作流：
```
1. 用户提交需求
2. OpenCode 生成详细的执行计划（不实际执行）
3. 人工审查计划
4. 批准后，OpenCode 按照计划执行
```

**需要确认：**
- OpenCode 是否原生支持这种两阶段工作流？
- 如果不支持，有哪些变通方案？
- 是否可以通过某种方式"暂停"执行，等待人工确认？

### 4. 与 nanobot 集成的最佳实践

**需要了解：**
- OpenCode 是否有 API 接口（而不仅仅是 CLI）？
- 如何通过程序化方式调用 OpenCode？
- 如何捕获和解析 OpenCode 的输出？
- 错误处理的最佳实践是什么？

## 测试环境信息

- **OpenCode 版本**：1.1.33
- **当前可用的模型**：qwen3-coder-plus
- **认证配置**：已配置 Anthropic 和 Alibaba (China) 的 API 认证

## 期望输出

1. **明确的答案**：OpenCode 是否支持我们需要的工作流？
2. **具体的命令示例**：如何正确使用 session 功能？
3. **替代方案**：如果原生不支持，有哪些可行的变通方案？
4. **集成建议**：基于实际能力，给出与 nanobot 集成的最佳方案

## 参考资料

- 之前的研究报告假设 OpenCode 支持 JSON 输出和 session 管理
- 实际测试发现这些假设可能不准确
- 需要基于 OpenCode 的实际文档和源码进行验证
